{
  "name": "WF_C_Targets_For_PT",
  "nodes": [
    {
      "parameters": {},
      "name": "Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "8881a7ec-1878-4e10-94c8-6838f00aaacc"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "product_type_id",
              "value": "={{ $json.product_type_id }}"
            },
            {
              "name": "acunetix_endpoint",
              "value": "={{ $json.acunetix_endpoint || $json.selected_acu_node?.endpoint || '' }}"
            },
            {
              "name": "acunetix_api_key",
              "value": "={{ $json.selected_acu_node?.api_key || $json.selected_acu_node?.token || '' }}"
            },
            {
              "name": "acunetix_token",
              "value": "={{ $json.selected_acu_node?.token || $json.selected_acu_node?.api_key || '' }}"
            },
            {
              "name": "acunetix_node_name",
              "value": "={{ $json.acunetix_node_name || $json.selected_acu_node?.name || '' }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Parameters",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        208,
        0
      ],
      "id": "b60803c9-c7f8-4192-a02d-c71c6095580b"
    },
    {
      "parameters": {
        "command": "=DOJO_API_TOKEN=\"{{$env.DOJO_API_TOKEN}}\" \\\npython3 /opt/tools/process_nmap_ips_for_pt.py \\\n  --product-type-id {{$json[\"product_type_id\"].toString()}} \\\n  --xml-dir /tmp \\\n  --api-token \"$DOJO_API_TOKEN\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        416,
        0
      ],
      "id": "3762ce5b-c66a-4a26-9b9f-83c039540cca",
      "name": "Execute Command"
    },
    {
      "parameters": {
        "command": "=python3 /opt/tools/acunetix_sync_pt.py \\\n  --dojo-base-url {{$env.DOJO_BASE_URL || 'http://localhost:8080/api/v2'}} \\\n  --dojo-api-token {{$env.DOJO_API_TOKEN}} \\\n  --product-type-id {{ $('Set Parameters').item.json.product_type_id }} \\\n  --acu-node-json '{{ JSON.stringify($(\"Validate Acunetix Node\").item.json.selected_acu_node) }}'\n "
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        624,
        0
      ],
      "id": "2381b203-8544-4e50-a98f-0cfb818f3235",
      "name": "Sync Acunetix Group"
    },
    {
      "parameters": {
        "command": "=python3 /opt/tools/acunetix_set_group_scan_speed.py \\\n  --acu-node-json '{{ JSON.stringify($(\"Validate Acunetix Node\").item.json.selected_acu_node) }}' \\\n  --group-id {{ $json.group_id }} \\\n  --scan-speed sequential\n"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1040,
        0
      ],
      "id": "d7566881-9c82-4564-8538-2546bf40e85d",
      "name": "Execute Command1"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import json\nimport os\nimport sqlite3\nfrom datetime import datetime, timezone\n\nitem = items[0]\ncontext = item.get(\"json\", {})\nstdout = context.get(\"stdout\", \"\")\n\ntry:\n    parsed = json.loads(stdout)\nexcept Exception as e:\n    raise Exception(f\"Не удалось распарсить stdout как JSON\\n{stdout}\\nОшибка: {e}\")\n\npt_id = context.get('pt_id', context.get('product_type_id'))\npt_id_str = str(pt_id) if pt_id is not None else ''\nMAPPING_DB_PATH = (os.environ.get('ACUNETIX_MAPPING_DB') or '/tmp/acunetix_mapping_store.sqlite3').strip()\n\ndef now_iso():\n    return datetime.now(timezone.utc).isoformat()\n\ndef init_db(conn):\n    conn.execute(\"\"\"\n        CREATE TABLE IF NOT EXISTS acunetix_mapping (\n            pt_id TEXT NOT NULL,\n            product_id TEXT NOT NULL,\n            selected_acu_node TEXT,\n            target_id TEXT,\n            updated_at TEXT NOT NULL,\n            PRIMARY KEY (pt_id, product_id)\n        )\n    \"\"\")\n\ndef normalize_selected_node(raw):\n    if not isinstance(raw, dict):\n        return None\n    endpoint = str(raw.get('endpoint') or '').strip().rstrip('/')\n    token = str(raw.get('api_key') or raw.get('token') or '').strip()\n    if not endpoint or not token:\n        return None\n    return {'endpoint': endpoint, 'name': str(raw.get('name') or 'acu-selected').strip() or 'acu-selected', 'weight': max(1, int(raw.get('weight', 1) or 1))}\n\ndef nodes_equal(lhs, rhs):\n    return isinstance(lhs, dict) and isinstance(rhs, dict) and str(lhs.get('endpoint') or '').strip().rstrip('/') == str(rhs.get('endpoint') or '').strip().rstrip('/') and str(lhs.get('name') or '').strip() == str(rhs.get('name') or '').strip()\n\nselected_node = normalize_selected_node(context.get('selected_acu_node'))\ntarget_mapping = parsed.get(\"target_mapping\", {})\ncreation_node = parsed.get('debug', {}).get('acu_base_url')\nselected_endpoint = (selected_node or {}).get('endpoint')\nif selected_endpoint and creation_node and str(selected_endpoint).strip().rstrip('/') != str(creation_node).strip().rstrip('/'):\n    raise Exception(f\"Target creation node mismatch: selected endpoint '{selected_endpoint}' != actual sync endpoint '{creation_node}'.\")\n\nnormalized_mapping = {}\nwf_d_payload = []\nif isinstance(target_mapping, dict):\n    for dojo_product_id, acunetix_target_id in target_mapping.items():\n        dojo_product_id = str(dojo_product_id or '').strip()\n        acunetix_target_id = str(acunetix_target_id or '').strip()\n        if not dojo_product_id or not acunetix_target_id:\n            continue\n        row = {'dojo_product_id': dojo_product_id, 'acunetix_target_id': acunetix_target_id, 'target_id': acunetix_target_id, 'pt_id': pt_id}\n        normalized_mapping[dojo_product_id] = row\n        wf_d_payload.append({'pt_id': pt_id, 'product_id': dojo_product_id, 'target_id': acunetix_target_id, 'acunetix_target_id': acunetix_target_id, 'selected_acu_node': selected_node})\n\nupserted = 0\npt_node_reconcile = {'status': 'noop', 'event': None}\nif MAPPING_DB_PATH:\n    try:\n        conn = sqlite3.connect(MAPPING_DB_PATH, timeout=30)\n        with conn:\n            init_db(conn)\n            if pt_id_str and selected_node:\n                prev = conn.execute(\"SELECT selected_acu_node FROM acunetix_mapping WHERE pt_id=? AND selected_acu_node IS NOT NULL ORDER BY updated_at DESC LIMIT 1\", (pt_id_str,)).fetchone()\n                if prev and prev[0]:\n                    try:\n                        prev_node = json.loads(prev[0])\n                    except Exception:\n                        prev_node = None\n                    if prev_node and not nodes_equal(prev_node, selected_node):\n                        pt_node_reconcile = {'status': 'reconciled', 'event': {'stage': 'wf_c_targets_for_pt', 'pt_id': pt_id, 'message': 'PT→Acunetix node cache mismatch detected; synchronized from runtime node.', 'primary': {'endpoint': selected_node.get('endpoint'), 'name': selected_node.get('name')}, 'secondary_before': {'endpoint': prev_node.get('endpoint'), 'name': prev_node.get('name')}}}\n            ts = now_iso()\n            for product_id, row in normalized_mapping.items():\n                conn.execute(\"INSERT INTO acunetix_mapping(pt_id,product_id,selected_acu_node,target_id,updated_at) VALUES(?,?,?,?,?) ON CONFLICT(pt_id,product_id) DO UPDATE SET selected_acu_node=excluded.selected_acu_node,target_id=excluded.target_id,updated_at=excluded.updated_at\", (pt_id_str, str(product_id), json.dumps(selected_node, ensure_ascii=False) if selected_node else None, str(row.get('target_id') or ''), ts))\n                upserted += 1\n        conn.close()\n    except Exception as e:\n        raise Exception(f\"Не удалось сохранить mapping в SQLite {MAPPING_DB_PATH}: {e}\")\n\nreturn [{\"json\": {\"pt_id\": pt_id, \"selected_acu_node\": selected_node, \"group_id\": parsed.get(\"group_id\"), \"target_mapping\": normalized_mapping, \"dojo_product_to_acunetix_target_mapping\": normalized_mapping, \"mapping_output\": {\"backend\": \"sqlite\", \"db_path\": MAPPING_DB_PATH, \"upserted\": upserted}, \"target_mapping_store\": MAPPING_DB_PATH, \"pt_node_reconcile\": pt_node_reconcile, \"creation_node_check\": {\"selected_endpoint\": selected_endpoint, \"sync_endpoint\": creation_node, \"match\": (str(selected_endpoint).strip().rstrip('/') == str(creation_node).strip().rstrip('/')) if selected_endpoint and creation_node else None}, \"wf_d_payload\": wf_d_payload, \"sync_summary\": {\"group_id\": parsed.get(\"group_id\"), \"mapped_targets\": len(normalized_mapping), \"has_debug\": isinstance(parsed.get(\"debug\"), dict)}}}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        0
      ],
      "id": "4c48ade9-718e-405b-89c1-1beab80ed6e0",
      "name": "Code in Python (Beta)"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "item = $json\nraw = item.get('product_type_id')\n\ntry:\n    product_type_id = int(raw)\nexcept Exception:\n    raise Exception(f'product_type_id is missing or invalid: {raw}')\n\nif product_type_id <= 0:\n    raise Exception(f'product_type_id must be > 0, got: {raw}')\n\nreturn [{\n    'json': {\n        **item,\n        'product_type_id': product_type_id\n    }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        0
      ],
      "id": "c-validate-product-type-id",
      "name": "Validate Product Type ID"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import json\nimport os\n\n\ndef parse_positive_int(value, default):\n    try:\n        parsed = int(value)\n        if parsed > 0:\n            return parsed\n    except Exception:\n        pass\n    return default\n\n\ndef normalize_selected_node(raw):\n    if not isinstance(raw, dict):\n        return None\n    endpoint = str(raw.get('endpoint') or '').strip().rstrip('/')\n    token = str(raw.get('api_key') or raw.get('token') or '').strip()\n    if not endpoint:\n        return None\n    if not token:\n        return {\n            'endpoint': endpoint,\n            'name': str(raw.get('name') or 'acu-selected').strip() or 'acu-selected',\n            'weight': parse_positive_int(raw.get('weight', 1), 1),\n        }\n    return {\n        'endpoint': endpoint,\n        'api_key': token,\n        'token': token,\n        'name': str(raw.get('name') or 'acu-selected').strip() or 'acu-selected',\n        'weight': parse_positive_int(raw.get('weight', 1), 1),\n    }\n\n\nitem = $json\npt_id = item.get('pt_id', item.get('product_type_id'))\nincoming_selected_node = normalize_selected_node(item.get('selected_acu_node')) or {}\n\nendpoint = str(item.get('acunetix_endpoint') or incoming_selected_node.get('endpoint') or '').strip().rstrip('/')\nnode_name = (item.get('acunetix_node_name') or incoming_selected_node.get('name') or 'acu-selected').strip() or 'acu-selected'\n\nif not endpoint:\n    raise Exception(f'WF_C_Targets_For_PT stage config error (pt_id={pt_id}): acunetix_endpoint is required. Pass selected node endpoint from orchestrator payload.')\n\nruntime_api_key = str(incoming_selected_node.get('api_key') or incoming_selected_node.get('token') or '').strip()\n\nif not runtime_api_key:\n    raw_nodes = (os.environ.get('ACUNETIX_INSTANCES_JSON') or '').strip()\n    if raw_nodes:\n        try:\n            parsed_nodes = json.loads(raw_nodes)\n            if isinstance(parsed_nodes, list):\n                normalized_endpoint = endpoint.rstrip('/')\n                for candidate in parsed_nodes:\n                    normalized_candidate = normalize_selected_node(candidate)\n                    if not normalized_candidate:\n                        continue\n                    candidate_endpoint = str(normalized_candidate.get('endpoint') or '').strip().rstrip('/')\n                    candidate_name = str(normalized_candidate.get('name') or '').strip()\n                    if candidate_endpoint == normalized_endpoint or (candidate_name and candidate_name == node_name):\n                        runtime_api_key = str(normalized_candidate.get('api_key') or normalized_candidate.get('token') or '').strip()\n                        if runtime_api_key:\n                            if not node_name and candidate_name:\n                                node_name = candidate_name\n                            break\n        except Exception:\n            runtime_api_key = runtime_api_key\n\nif not runtime_api_key:\n    raise Exception(f'WF_C_Targets_For_PT stage config error (pt_id={pt_id}): Acunetix API key must come from runtime selected_acu_node or ACUNETIX_INSTANCES_JSON.')\n\nselected_node = normalize_selected_node({\n    'endpoint': endpoint,\n    'api_key': runtime_api_key,\n    'token': runtime_api_key,\n    'name': node_name,\n    'weight': incoming_selected_node.get('weight', 1),\n})\n\nreturn [{\n    'json': {\n        **item,\n        'pt_id': item.get('pt_id', item.get('product_type_id')),\n        'selected_acu_node': selected_node,\n        'acunetix_endpoint': endpoint,\n        'acunetix_api_key': runtime_api_key,\n        'acunetix_token': runtime_api_key,\n        'acunetix_node_name': node_name,\n        'acu_node_source': 'runtime_config',\n    }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        0
      ],
      "id": "c-validate-acunetix-node",
      "name": "Validate Acunetix Node"
    }
  ],
  "pinData": {},
  "connections": {
    "Trigger": {
      "main": [
        [
          {
            "node": "Set Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Parameters": {
      "main": [
        [
          {
            "node": "Validate Product Type ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Command": {
      "main": [
        [
          {
            "node": "Sync Acunetix Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sync Acunetix Group": {
      "main": [
        [
          {
            "node": "Code in Python (Beta)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in Python (Beta)": {
      "main": [
        [
          {
            "node": "Execute Command1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Product Type ID": {
      "main": [
        [
          {
            "node": "Validate Acunetix Node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Acunetix Node": {
      "main": [
        [
          {
            "node": "Execute Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f219f7ce-7867-484a-8806-8e183d70eba5",
  "meta": {
    "instanceId": "d06b9c37a455942c350bdf64d5764dfb5548ea5097bfb316251734323f35ea3f"
  },
  "id": "OsOBICmnEtSDo8Sm",
  "tags": []
}