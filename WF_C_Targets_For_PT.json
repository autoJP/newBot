{
  "name": "WF_C_Targets_For_PT",
  "nodes": [
    {
      "parameters": {},
      "name": "Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "8881a7ec-1878-4e10-94c8-6838f00aaacc"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "product_type_id",
              "value": "={{ $json.product_type_id }}"
            },
            {
              "name": "acunetix_endpoint",
              "value": "={{ $json.acunetix_endpoint || $json.selected_acu_node?.endpoint || '' }}"
            },
            {
              "name": "acunetix_token",
              "value": "={{ $json.acunetix_token || $json.selected_acu_node?.token || '' }}"
            },
            {
              "name": "acunetix_node_name",
              "value": "={{ $json.acunetix_node_name || $json.selected_acu_node?.name || '' }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Parameters",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        208,
        0
      ],
      "id": "b60803c9-c7f8-4192-a02d-c71c6095580b"
    },
    {
      "parameters": {
        "command": "=DOJO_API_TOKEN=\"{{$env.DOJO_API_TOKEN}}\" \\\npython3 /opt/tools/process_nmap_ips_for_pt.py \\\n  --product-type-id {{$json[\"product_type_id\"].toString()}} \\\n  --xml-dir /tmp \\\n  --api-token \"$DOJO_API_TOKEN\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        416,
        0
      ],
      "id": "3762ce5b-c66a-4a26-9b9f-83c039540cca",
      "name": "Execute Command"
    },
    {
      "parameters": {
        "command": "=python3 /opt/tools/acunetix_sync_pt.py \\\n  --dojo-base-url {{$env.DOJO_BASE_URL || 'http://localhost:8080/api/v2'}} \\\n  --dojo-api-token {{$env.DOJO_API_TOKEN}} \\\n  --product-type-id {{ $('Set Parameters').item.json.product_type_id }} \\\n  --acu-endpoint {{ $('Validate Acunetix Node').item.json.acunetix_endpoint }} \\\n  --acu-token {{ $('Validate Acunetix Node').item.json.acunetix_token }} \\\n  --acu-node-name {{ $('Validate Acunetix Node').item.json.acunetix_node_name || 'unspecified' }}\n "
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        624,
        0
      ],
      "id": "2381b203-8544-4e50-a98f-0cfb818f3235",
      "name": "Sync Acunetix Group"
    },
    {
      "parameters": {
        "command": "=python3 /opt/tools/acunetix_set_group_scan_speed.py \\\n  --acu-endpoint {{ $('Validate Acunetix Node').item.json.acunetix_endpoint }} \\\n  --acu-token {{ $('Validate Acunetix Node').item.json.acunetix_token }} \\\n  --acu-node-name {{ $('Validate Acunetix Node').item.json.acunetix_node_name || 'unspecified' }} \\\n  --group-id {{ $json.group_id }} \\\n  --scan-speed sequential\n"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1040,
        0
      ],
      "id": "d7566881-9c82-4564-8538-2546bf40e85d",
      "name": "Execute Command1"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import json\n\n# n8n подаёт данные в переменной `items`\nitem = items[0]  # берём первый элемент\nstdout = item.get(\"json\", {}).get(\"stdout\", \"\")\n\ntry:\n    parsed = json.loads(stdout)\nexcept Exception as e:\n    raise Exception(f\"Не удалось распарсить stdout как JSON:\\n{stdout}\\nОшибка: {e}\")\n\n# Формируем новый объект вывода\nreturn [{\n    \"json\": {\n        \"group_id\": parsed.get(\"group_id\"),\n        \"full_output\": parsed\n    }\n}]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        0
      ],
      "id": "4c48ade9-718e-405b-89c1-1beab80ed6e0",
      "name": "Code in Python (Beta)"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "item = $json\nraw = item.get('product_type_id')\n\ntry:\n    product_type_id = int(raw)\nexcept Exception:\n    raise Exception(f'product_type_id is missing or invalid: {raw}')\n\nif product_type_id <= 0:\n    raise Exception(f'product_type_id must be > 0, got: {raw}')\n\nreturn [{\n    'json': {\n        **item,\n        'product_type_id': product_type_id\n    }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        0
      ],
      "id": "c-validate-product-type-id",
      "name": "Validate Product Type ID"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "item = $json\n\nendpoint = (item.get('acunetix_endpoint') or '').strip()\ntoken = (item.get('acunetix_token') or '').strip()\nnode_name = (item.get('acunetix_node_name') or '').strip()\n\nif not endpoint:\n    raise Exception('acunetix_endpoint is required. Pass selected node endpoint from orchestrator/dispatcher.')\nif not token:\n    raise Exception('acunetix_token is required. Pass selected node token from orchestrator/dispatcher.')\n\nreturn [{\n    'json': {\n        **item,\n        'acunetix_endpoint': endpoint,\n        'acunetix_token': token,\n        'acunetix_node_name': node_name,\n    }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        0
      ],
      "id": "c-validate-acunetix-node",
      "name": "Validate Acunetix Node"
    }
  ],
  "pinData": {},
  "connections": {
    "Trigger": {
      "main": [
        [
          {
            "node": "Set Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Parameters": {
      "main": [
        [
          {
            "node": "Validate Product Type ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Command": {
      "main": [
        [
          {
            "node": "Sync Acunetix Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sync Acunetix Group": {
      "main": [
        [
          {
            "node": "Code in Python (Beta)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in Python (Beta)": {
      "main": [
        [
          {
            "node": "Execute Command1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Product Type ID": {
      "main": [
        [
          {
            "node": "Validate Acunetix Node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Acunetix Node": {
      "main": [
        [
          {
            "node": "Execute Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f219f7ce-7867-484a-8806-8e183d70eba5",
  "meta": {
    "instanceId": "d06b9c37a455942c350bdf64d5764dfb5548ea5097bfb316251734323f35ea3f"
  },
  "id": "OsOBICmnEtSDo8Sm",
  "tags": []
}
