{
  "name": "WF_D_ProductScan",
  "nodes": [
    {
      "parameters": {},
      "id": "p-trigger",
      "name": "Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -1320,
        220
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{ ($env.DOJO_BASE_URL || 'http://localhost:8080/api/v2').replace(/\\/+$/,'') + '/products/' + $json.product_id + '/' }}",
        "options": {}
      },
      "id": "p-product",
      "name": "Get Product",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -1120,
        220
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "mGl4PbJkKfeJbTg8",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ (($node['Trigger'].json.acunetix_endpoint || $env.ACUNETIX_BASE_URL || 'https://localhost:3443')).replace(/\\/+$/,'') + '/api/v1/scans?l=100&q=' + encodeURIComponent($json.name) }}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-Auth",
              "value": "={{ $json.acunetix_token || $node['Trigger'].json.acunetix_token || $env.ACUNETIX_API_KEY || '' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "p-existing",
      "name": "Check Existing Acunetix Scans",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -920,
        220
      ]
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import os, json, urllib.request\n\ndef parse_instances():\n    raw = (os.environ.get('ACUNETIX_INSTANCES_JSON') or '').strip()\n    out = []\n    if raw:\n        try:\n            arr = json.loads(raw)\n            if isinstance(arr, list):\n                for idx, item in enumerate(arr):\n                    if isinstance(item, dict) and item.get('endpoint') and item.get('token'):\n                        out.append({'name': item.get('name') or f'acu-{idx+1}', 'endpoint': str(item.get('endpoint')).rstrip('/'), 'token': str(item.get('token'))})\n        except Exception:\n            pass\n    if not out:\n        token = (os.environ.get('ACUNETIX_API_KEY') or '').strip()\n        endpoint = (os.environ.get('ACUNETIX_BASE_URL') or 'https://localhost:3443').rstrip('/')\n        if token:\n            out.append({'name':'acu-default','endpoint':endpoint,'token':token})\n    return out\n\ndef choose_node():\n    incoming_ep = ($node['Trigger'].json or {}).get('acunetix_endpoint')\n    incoming_token = ($node['Trigger'].json or {}).get('acunetix_token')\n    incoming_name = ($node['Trigger'].json or {}).get('acunetix_node_name') or 'acu-selected'\n    if incoming_ep and incoming_token:\n        return {'name': incoming_name, 'endpoint': str(incoming_ep).rstrip('/'), 'token': str(incoming_token)}\n    for node in parse_instances():\n        try:\n            req = urllib.request.Request(node['endpoint'] + '/api/v1/me')\n            req.add_header('X-Auth', node['token'])\n            with urllib.request.urlopen(req, timeout=6) as resp:\n                if 200 <= getattr(resp, 'status', 200) <= 299:\n                    return node\n        except Exception:\n            continue\n    return None\n\nproduct = $node['Get Product'].json\nexisting = $json.get('scans', []) or []\nnode = choose_node()\nif not node:\n    return [{'json': {'skip': True, 'reason': 'no healthy acunetix nodes', 'product_id': product.get('id'), 'product_name': product.get('name')}}]\n\nfor s in existing:\n    status = (s.get('current_session') or {}).get('status', '')\n    if status in ['processing', 'scheduled', 'queued', 'starting']:\n        return [{'json': {\n            'skip': True,\n            'reason': 'scan already active',\n            'product_id': product.get('id'),\n            'product_name': product.get('name'),\n            'scan_id': s.get('scan_id'),\n            'acunetix_node_name': node['name'],\n            'acunetix_endpoint': node['endpoint'],\n            'acunetix_token': node['token'],\n        }}]\n\nreturn [{'json': {\n    'skip': False,\n    'product_id': product.get('id'),\n    'product_name': product.get('name'),\n    'target_url': f\"https://{product.get('name')}\",\n    'acunetix_node_name': node['name'],\n    'acunetix_endpoint': node['endpoint'],\n    'acunetix_token': node['token'],\n}}]"
      },
      "id": "p-gate",
      "name": "Duplicate Guard (Python)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -700,
        220
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip }}"
            }
          ]
        }
      },
      "id": "p-if-skip",
      "name": "Skip new launch?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -500,
        220
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ (($json.acunetix_endpoint || $node['Trigger'].json.acunetix_endpoint || $env.ACUNETIX_BASE_URL || 'https://localhost:3443')).replace(/\\/+$/,'') + '/api/v1/scans' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"target_id\": $json.product_name, \"profile_id\": \"11111111-1111-1111-1111-111111111111\", \"schedule\": {\"disable\": false, \"start_date\": null, \"time_sensitive\": false}}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-Auth",
              "value": "={{ $json.acunetix_token || $node['Trigger'].json.acunetix_token || $env.ACUNETIX_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "p-start",
      "name": "Start Scan",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -280,
        120
      ]
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import time\nitem = dict($json)\nitem['started_at_epoch'] = int(time.time())\nitem['poll_count'] = 0\nitem['max_poll_count'] = 40\nreturn [{ 'json': item }]"
      },
      "id": "p-init-poll",
      "name": "Init Poll Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -180,
        120
      ]
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "seconds"
      },
      "id": "p-wait",
      "name": "Polling Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -80,
        120
      ]
    },
    {
      "parameters": {
        "url": "={{ (($node['Trigger'].json.acunetix_endpoint || $env.ACUNETIX_BASE_URL || 'https://localhost:3443')).replace(/\\/+$/,'') + '/api/v1/scans/' + $node['Start Scan'].json.scan_id }}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-Auth",
              "value": "={{ $json.acunetix_token || $node['Trigger'].json.acunetix_token || $env.ACUNETIX_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "p-status",
      "name": "Get Scan Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        120,
        120
      ]
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import time\ns = ($json.get('current_session') or {})\nstatus = s.get('status', '')\nfinished = status in ['completed', 'failed', 'aborted']\npoll_count = len(_(\"Get Scan Status\").all())\ninit = _(\"Init Poll Context\").first().json if len(_(\"Init Poll Context\").all()) else {}\nstarted_at_epoch = int(init.get('started_at_epoch', int(time.time())))\nmax_poll_count = int(init.get('max_poll_count', 40))\ntimed_out = (not finished) and poll_count >= max_poll_count\nreturn [{ 'json': { 'status': status, 'finished': finished, 'timed_out': timed_out, 'poll_count': poll_count, 'max_poll_count': max_poll_count, 'started_at_epoch': started_at_epoch } }]"
      },
      "id": "p-check",
      "name": "Check Finished (Python)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        120
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.finished || $json.timed_out }}"
            }
          ]
        }
      },
      "id": "p-if-finished",
      "name": "Finished?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        520,
        120
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.timed_out }}"
            }
          ]
        }
      },
      "id": "p-if-timeout",
      "name": "Timed out?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        700,
        200
      ]
    },
    {
      "parameters": {
        "message": "=Scan polling timed out after {{$json.poll_count}} checks (limit {{$json.max_poll_count}})."
      },
      "id": "p-timeout-error",
      "name": "Timeout Error",
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        900,
        280
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ (($node['Trigger'].json.acunetix_endpoint || $env.ACUNETIX_BASE_URL || 'https://localhost:3443')).replace(/\\/+$/,'') + '/api/v1/reports' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"template_id\": \"11111111-1111-1111-1111-111111111111\", \"source\": {\"list_type\": \"scans\", \"id_list\": [$node['Start Scan'].json.scan_id]}}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-Auth",
              "value": "={{ $json.acunetix_token || $node['Trigger'].json.acunetix_token || $env.ACUNETIX_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "p-report",
      "name": "Generate Report",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        740,
        120
      ]
    },
    {
      "parameters": {
        "url": "={{ (($node['Trigger'].json.acunetix_endpoint || $env.ACUNETIX_BASE_URL || 'https://localhost:3443')).replace(/\\/+$/,'') + '/api/v1/reports/' + $json.report_id + '/download' }}",
        "responseFormat": "file",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-Auth",
              "value": "={{ $json.acunetix_token || $node['Trigger'].json.acunetix_token || $env.ACUNETIX_API_KEY || '' }}"
            }
          ]
        }
      },
      "id": "p-export",
      "name": "Export XML",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        960,
        120
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ ($env.DOJO_BASE_URL || 'http://localhost:8080/api/v2').replace(/\\/+$/,'') + '/import-scan/' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "scan_type",
              "value": "Acunetix Scan"
            },
            {
              "name": "product",
              "value": "={{ $node['Duplicate Guard (Python)'].json.product_id }}"
            },
            {
              "name": "active",
              "value": "true"
            },
            {
              "name": "verified",
              "value": "true"
            },
            {
              "name": "minimum_severity",
              "value": "Info"
            },
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "auto_create_context",
              "value": "true"
            }
          ]
        }
      },
      "id": "p-import",
      "name": "Import XML to DefectDojo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1180,
        120
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "mGl4PbJkKfeJbTg8",
          "name": "Header Auth account"
        }
      }
    }
  ],
  "connections": {
    "Trigger": {
      "main": [
        [
          {
            "node": "Get Product",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Product": {
      "main": [
        [
          {
            "node": "Check Existing Acunetix Scans",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Existing Acunetix Scans": {
      "main": [
        [
          {
            "node": "Duplicate Guard (Python)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Duplicate Guard (Python)": {
      "main": [
        [
          {
            "node": "Skip new launch?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip new launch?": {
      "main": [
        [],
        [
          {
            "node": "Start Scan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start Scan": {
      "main": [
        [
          {
            "node": "Init Poll Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Polling Wait": {
      "main": [
        [
          {
            "node": "Get Scan Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Scan Status": {
      "main": [
        [
          {
            "node": "Check Finished (Python)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Finished (Python)": {
      "main": [
        [
          {
            "node": "Finished?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finished?": {
      "main": [
        [
          {
            "node": "Timed out?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Polling Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Report": {
      "main": [
        [
          {
            "node": "Export XML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Export XML": {
      "main": [
        [
          {
            "node": "Import XML to DefectDojo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Init Poll Context": {
      "main": [
        [
          {
            "node": "Polling Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Timed out?": {
      "main": [
        [
          {
            "node": "Timeout Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}